#!/usr/bin/env sh

PID_FILE=~/.config/dwmbar/pid
SLP_FILE=~/.config/dwmbar/slp

trap 'update; echo updating...' 5
trap 'rm -f $PID_FILE $SLP_FILE;' EXIT
trap 'echo "$0 is terminating ..."; exit 1' 15

echo $$ > $PID_FILE


delimright=""
delim="⏽"
delimleft=""
mplay=""
mpause=""
mstop=""
volmute=""
vollow=""
volmed=""
volhigh=""

checkweather() {
	[ "$(stat -c %y "$HOME/.local/share/weatherreport" 2>/dev/null | cut -d' ' -f1)" != "$(date '+%Y-%m-%d')" ] &&
	curl -s "wttr.in" > "$HOME/.local/share/weatherreport" &&
	dwmbar_ref
}

status() {
	echo "$delimright"
	currentstate="$(mpc | grep -E 'playing|paused' | cut -d' ' -f1 | tail -c +2 | head -c -2)"
	case $currentstate in
		playing)
			echo "$mplay"
		;;
		paused)
			echo "$mpause"
		;;
		*)
			echo "$mstop"
		;;
	esac
	mpc -f "[[%artist% - ]%title%]|[%file%]" 2>/dev/null | grep -v "volume" | head -n 1
	echo "$delim"
	
	echo "Master:"
	amixer -D pulse get Master | grep -o "[0-9]*%\|\[on\]\|\[off\]" | sed -e "s/\b[0-9]%/\ \ &/;s/\b[0-9]\{2\}%/\ &/;s/\[on\]/$volhi/;s/\[off\]/$volmu/" | tr '\n' ':' | cut -d':' -f1-2 | tr ':' '\n'
	echo "MPD:"
	mpc | grep vol | cut -d' ' -f1-3 | cut -d':' -f2 | sed "s/\%\ */\% $volhi/"
	echo "$delim"

	[ "$(stat -c %y "$HOME/.local/share/weatherreport" 2>/dev/null | cut -d' ' -f1)" = "$(date '+%Y-%m-%d')" ] &&
	sed '16q;d' "$HOME/.local/share/weatherreport" | grep -wo "[0-9]*%" | sort -n | sed -e '$!d' | sed 's/.$//' | sed -e "s/$/  /g" | tr -d '\n' &&
	sed '13q;d' "$HOME/.local/share/weatherreport" | grep -o "m\\(-\\)*[0-9]\\+" | sort -n -t 'm' -k 2n | sed -e 1b -e '$!d' | tr '\n|m' ' ' | awk '{print " ",$1 "","",$2 ""}' &&
	echo "$delim"

	echo "Updates:"
	checkupdates | wc -l
	echo "$delim"

	# Date and time.
	date '+%B %d %A %H:%M'
	echo "$delimleft"
}

update() {
	checkweather &
    wait
	xsetroot -name "$(status | tr '\n' ' ')" &
    wait
}

while :
do
	update &
	sleep 30s &
	echo $! > $SLP_FILE
	wait $(cat $SLP_FILE)
done
